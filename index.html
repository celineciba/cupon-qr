<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CÉLINE — Cupón de beneficio</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="card">
    <div class="banner"></div>

    <h1>Cupón de beneficio</h1>
    <p class="sub">Completa tus datos y genera tu cupón. Presenta el cupón en caja para validación.</p>

    <form id="f" novalidate>
      <label>NOMBRE Y APELLIDO</label>
      <input id="nombre" name="nombre" placeholder="Ej. Juan Pérez" required minlength="5" />

      <label>WHATSAPP</label>
      <div class="row2">
        <select id="pais" name="pais" required>
          <option value="" selected disabled>Selecciona tu país</option>
          <option value="Ecuador (+593)" data-code="+593">Ecuador (+593)</option>
          <option value="Colombia (+57)" data-code="+57">Colombia (+57)</option>
          <option value="Perú (+51)" data-code="+51">Perú (+51)</option>
          <option value="Chile (+56)" data-code="+56">Chile (+56)</option>
          <option value="Argentina (+54)" data-code="+54">Argentina (+54)</option>
          <option value="México (+52)" data-code="+52">México (+52)</option>
          <option value="España (+34)" data-code="+34">España (+34)</option>
          <option value="Estados Unidos (+1)" data-code="+1">Estados Unidos (+1)</option>
          <option value="Otro" data-code="">Otro (selecciona y escribe tu número)</option>
        </select>

        <input id="celular" name="celular" placeholder="Solo dígitos" required inputmode="numeric" />
      </div>
      <p class="hint">Elige tu país y escribe tu número de WhatsApp (solo dígitos).</p>

      <label>CORREO</label>
      <input id="email" name="email" placeholder="Ej. nombre@gmail.com" required type="email" />

      <label>RED FAVORITA</label>
      <select id="red" name="red" required>
        <option value="" selected disabled>Selecciona...</option>
        <option value="Instagram">Instagram</option>
        <option value="TikTok">TikTok</option>
        <option value="Facebook">Facebook</option>
        <option value="Otro">Otro</option>
      </select>

      <label>USUARIO REAL / LINK</label>
      <input id="usuario" name="usuario" placeholder="@tuusuario o https://..." required />
      <p class="hint">Debe ser real: @usuario o un link válido (https://...)</p>

      <button id="btn" type="submit">GENERAR CUPÓN</button>

      <p id="msg" class="msg"></p>

      <p class="foot">
        Al enviar aceptas que CÉLINE use estos datos solo para esta promoción y novedades.
      </p>
    </form>
  </main>

  <script>
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbxuqU7JeMiO8e1XSjNMsvqWrTEeefNWSaRNAmT4SZSVxZRyTz6gSSggypQpAILVyjGSkQ/exec";
    const ORIGEN = "https://celineciba.github.io/cupon-qr/";

    const $ = (id) => document.getElementById(id);
    const msg = $("msg");
    const btn = $("btn");

    function onlyDigits(s){ return String(s||"").replace(/\D+/g,""); }
    function isValidUserOrLink(v){
      v = String(v||"").trim();
      if (!v) return false;
      if (v.startsWith("@")) return v.length >= 3;
      if (v.startsWith("http://") || v.startsWith("https://")) return true;
      return false;
    }

    $("f").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      msg.textContent = "";
      msg.className = "msg";

      const nombre = $("nombre").value.trim();
      const paisOpt = $("pais").selectedOptions[0];
      const pais = $("pais").value;
      const code = (paisOpt && paisOpt.dataset && paisOpt.dataset.code) ? paisOpt.dataset.code : "";
      const celular = onlyDigits($("celular").value);
      const email = $("email").value.trim();
      const red = $("red").value;
      const usuario = $("usuario").value.trim();

      if (!nombre || nombre.length < 5) return fail("Ingresa tu nombre y apellido (mínimo 5 caracteres).");
      if (!pais) return fail("Selecciona tu país de WhatsApp.");
      if (!celular || celular.length < 7) return fail("Ingresa tu número de WhatsApp (solo dígitos).");
      if (!email || !email.includes("@")) return fail("Ingresa un correo válido.");
      if (!red) return fail("Selecciona tu red favorita.");
      if (!isValidUserOrLink(usuario)) return fail("Ingresa un @usuario real o un link válido (https://...).");

      const wa_full = (code ? code : "") + celular;

      btn.disabled = true;
      btn.textContent = "GENERANDO...";

      try {
        const payload = {
          nombre,
          pais,
          celular,
          email,
          red,
          usuario,
          origen: ORIGEN,
          wa_full
        };

        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!data.ok) {
          if (data.error === "DUPLICADO") {
            return fail("Ya existe un cupón con esos datos. No puedes generar otro.");
          }
          return fail("Error: " + (data.error || "No se pudo generar el cupón"));
        }

        // Redirigir a la página elegante del cupón
        const url = new URL("coupon.html", window.location.href);
        url.searchParams.set("coupon", data.coupon);
        url.searchParams.set("nombre", nombre);
        url.searchParams.set("pais", pais);
        url.searchParams.set("wa_full", wa_full);
        window.location.href = url.toString();

      } catch (e) {
        fail("Error de conexión. Revisa la implementación del Apps Script (acceso: Cualquiera).");
      } finally {
        btn.disabled = false;
        btn.textContent = "GENERAR CUPÓN";
      }
    });

    function fail(t){
      msg.textContent = t;
      msg.className = "msg bad";
      return;
    }
  </script>
</body>
</html>
