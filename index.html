<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CÉLINE — Cupón de beneficio</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="card">
    <div class="banner">
      <img src="BANER.jpeg" alt="CÉLINE" />
    </div>

    <h1>Cupon de beneficio</h1>
    <p class="sub">Completa tus datos y genera tu cupón. Presenta el cupón en caja para validación.</p>

    <form id="f">
      <label>NOMBRE Y APELLIDO</label>
      <input id="nombre" required placeholder="Ej. Juan Pérez" />

      <label>WHATSAPP</label>
      <div class="row">
        <select id="pais" required></select>
        <input id="celular" required inputmode="numeric" placeholder="Solo dígitos" />
      </div>
      <div class="help">Elige tu país y escribe tu número de WhatsApp (solo dígitos).</div>

      <label>CORREO</label>
      <input id="email" type="email" required placeholder="Ej. nombre@gmail.com" />

      <label>RED FAVORITA</label>
      <select id="red" required>
        <option value="" selected disabled>Selecciona...</option>
        <option>Instagram</option>
        <option>TikTok</option>
        <option>Facebook</option>
        <option>Otro</option>
      </select>

      <label>USUARIO REAL / LINK</label>
      <input id="usuario" required placeholder="@tuusuario o https://..." />
      <div class="help">Debe ser real: @usuario o un link válido (https://...)</div>

      <button id="btn" type="submit">GENERAR CUPÓN</button>

      <p class="fine">Al enviar aceptas que CÉLINE use estos datos solo para esta promoción y novedades.</p>

      <div id="msg" class="msg" aria-live="polite"></div>
    </form>
  </main>

<script>
  // === TU WEB APP URL (Apps Script) ===
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuqU7JeMiO8e1XSjNMsvqWrTEeefNWSaRNAmT4SZSVxZRyTz6gSSggypQpAILVyjGSkQ/exec";
  const ORIGEN = "https://celineciba.github.io/cupon-qr/";

  const COUNTRIES = [
    ["Ecuador", "+593"],
    ["Colombia", "+57"],
    ["Perú", "+51"],
    ["Estados Unidos", "+1"],
    ["España", "+34"],
    ["México", "+52"],
    ["Argentina", "+54"],
    ["Chile", "+56"],
    ["Panamá", "+507"],
    ["Otro", ""]
  ];

  const elPais = document.getElementById("pais");
  COUNTRIES.forEach(([name, code]) => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = code ? `${name} (${code})` : `${name}`;
    opt.dataset.code = code;
    elPais.appendChild(opt);
  });
  elPais.value = "Ecuador";

  const msg = (t, ok=false) => {
    const m = document.getElementById("msg");
    m.textContent = t;
    m.className = "msg " + (ok ? "ok" : "err");
  };

  const onlyDigits = (s) => (s || "").replace(/\D+/g,"");

  const isValidUsuario = (s) => {
    s = (s||"").trim();
    if (!s) return false;
    if (s.startsWith("@") && s.length >= 3) return true;
    if (s.startsWith("https://") || s.startsWith("http://")) return true;
    return false;
  };

  const normalizeName = (s) => (s||"").trim().replace(/\s+/g," ");

  document.getElementById("celular").addEventListener("input", (e) => {
    e.target.value = onlyDigits(e.target.value);
  });

  document.getElementById("f").addEventListener("submit", async (e) => {
    e.preventDefault();
    msg("");

    const nombre  = normalizeName(document.getElementById("nombre").value);
    const pais    = elPais.value;
    const code    = (elPais.selectedOptions[0]?.dataset?.code || "").trim();
    const celular = onlyDigits(document.getElementById("celular").value);
    const email   = (document.getElementById("email").value || "").trim();
    const red     = document.getElementById("red").value;
    const usuario = (document.getElementById("usuario").value || "").trim();

    if (!nombre || nombre.length < 5) return msg("Escribe nombre y apellido real.");
    if (!pais) return msg("Selecciona país.");
    if (!celular || celular.length < 7) return msg("Número de WhatsApp inválido (solo dígitos).");
    if (!email) return msg("Correo inválido.");
    if (!red) return msg("Selecciona red favorita.");
    if (!isValidUsuario(usuario)) return msg("Usuario/link inválido. Usa @usuario o https://...");

    // Construimos WA_FULL (para guardar en hoja y usar en cupón)
    // Quitamos ceros iniciales típicos (ej: 09...) para no duplicar con +593
    let cel = celular;
    if (code === "+593" && cel.startsWith("0")) cel = cel.replace(/^0+/, "");
    const wa_full = (code ? code : "") + cel;

    const payload = { nombre, pais, celular: cel, email, red, usuario, origen: ORIGEN, wa_full };

    const btn = document.getElementById("btn");
    btn.disabled = true;
    btn.textContent = "GENERANDO...";

    try {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();

      if (!json.ok) {
        if (json.reason === "DUPLICATE") {
          msg(json.message || "Ya existe un cupón con estos datos. No se puede generar otro.");
        } else {
          msg(json.error || "Error de conexión / guardado.");
        }
        btn.disabled = false;
        btn.textContent = "GENERAR CUPÓN";
        return;
      }

      // Guardamos datos para mostrar en la página elegante
      const couponData = {
        coupon: json.coupon,
        nombre,
        pais: (code ? `${pais} (${code})` : pais),
        wa_full: wa_full,
        email,
        red,
        usuario
      };

      sessionStorage.setItem("CELINE_COUPON", JSON.stringify(couponData));

      // REDIRIGIR a página elegante
      window.location.href = "cupon.html";

    } catch (err) {
      msg("Error de conexión. Revisa que tu App web esté en acceso 'Cualquiera' y sea /exec.");
      btn.disabled = false;
      btn.textContent = "GENERAR CUPÓN";
    }
  });
</script>
</body>
</html>
